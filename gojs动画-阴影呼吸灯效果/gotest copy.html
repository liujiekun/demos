<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="js/go-debug.js"></script>
    <script src="js/Figures.js"></script>
    <script src="js/shapeFigure.js"></script>
    <script src="js/Animate copy.js"></script>
    <style>
      .container{
        display: flex;
      }
      #app {
        height: 500px;
        width: 1000px;
        border: 1px solid #000;
      }
      .right{
        display: flex;
      }
      .buttons{
        display: flex;
        flex-direction: column;
      }
      .button{
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="app">
      </div>
      <div class="right">
        <div class="buttons">
          <!-- <button class="button" onclick="breathLight('general')">基本</button>
          <button class="button" onclick="breathLight('warning')">警告</button>
          <button class="button" onclick="breathLight('serious')">严重</button>
          <button class="button" onclick="breathLight('emergency')">紧急</button>
          <button class="button" onclick="stopAnimation()">停止动画</button>
          -->
          <button class="button" onclick="clearMark()">清空标记</button> 
          <div>
            <button class="button" onclick="setProp()">设置state属性</button>
            <input id="setProp" type="text" />
          </div>

        </div>
        <div class="dataBinding">
          <table>
            <tr>
              <td>动画时长</td>
              <td>
                <input id="duration" type="text" placeholder="请输入动画时长"/>
              </td>
            </tr>
            <tr>
              <td>
                动画类型
              </td>
              <td>
                <select id="animationType" name="animationType">
                  <option>EaseInExpo</option>
                  <option selected>EaseInOutQuad</option>
                  <option>EaseInQuad</option>
                  <option>EaseLinear</option>
                  <option>EaseOutExpo</option>
                  <option>EaseOutQuad</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>动画循环次数</td>
              <td>
                <input id="runCount" type="text" placeholder="无限次请输入Infinity"/>
              </td>
            </tr>
            <tr>
              <td>动画触发条件</td>
              <td>
                <input id="animationProp" disabled="true" value="state" type="text" placeholder="输入动画触发属性"/>
              </td>
              <td>
                <select id="animationTarget" name="animationTarget">
                  <option>general</option>
                  <option selected>warning</option>
                  <option>serious</option>
                  <option>emergency</option>
                </select>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <script>
    var lastNode = null
    function init() {
      if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this
      var $ = go.GraphObject.make;

      myDiagram =
        $(go.Diagram, "app",  // create a Diagram for the DIV HTML element
          {
            "undoManager.isEnabled": true,
            allowResize: true
          });

      const myNodeTemplate = 
        $(go.Node,'Auto',
        new go.Binding('isShadowed'),
        new go.Binding('shadowColor'),
        new go.Binding('shadowOffset'),
        new go.Binding('shadowBlur'),

        $(go.Shape,{
          name: 'SHAPE',
          stroke: 'red',
          fill: 'lightblue',
          width:160,
          height:120,
        },
        new go.Binding('figure'),
        new go.Binding('shadowVisible')
        )
      )
      myDiagram.nodeTemplateMap.add('myNode',myNodeTemplate)
      const model = $(go.GraphLinksModel,{
        nodeDataArray:[{
          category:'myNode',
          figure:'Rectangle'
        },
        {
          category:'myNode',
          figure:'Circle'
        },
        {
          category:'myNode',
          figure:'Circle'
        },
        {
          category:'myNode',
          figure:'Circle'
        },
        {
          category:'myNode',
          figure:'Circle'
        },
        {
          category:'myNode',
          figure:'myCloud'
        }],
        linkDataArray:[]
      })
      myDiagram.model = model
    }
    init()
    function setProp(){
      const node = myDiagram.selection.first()
      const propEle = document.getElementById('setProp')
      const propVal = propEle.value
      myDiagram.startTransaction('setData');
      myDiagram.model.setDataProperty(node.data,'state',propVal);
      myDiagram.commitTransaction('setData')
    }
    myDiagram.addDiagramListener('ChangedSelection', e => {
      if(e.subject.size===1){
        const part = e.subject.first()
        if(!lastNode){
          lastNode = part
        } else {
          const formData = getDataFromForm()
          myDiagram.startTransaction('setData')
          let [duration,animationType,runCount,animationProp,animationTarget] = formData
          console.log('duration,animationType,runCount,animationProp,animationTarget', duration,animationType,runCount,animationProp,animationTarget)
          const newAnimation = new Animation(myDiagram, [lastNode], {animationTarget,duration,animationType,runCount})

          animationProp = 'state'
          animationTarget = animationTarget || 'general'
          const setData = myDiagram.model.setDataProperty.bind(myDiagram.model)
          setData(lastNode.data,'animation',newAnimation)
          setData(lastNode.data,'animationType',animationType)
          setData(lastNode.data,'animationProp',animationProp)
          setData(lastNode.data,'animationTarget',animationTarget)
          myDiagram.commitTransaction('setData')
        }
        const {animation,animationType, animationProp, animationTarget} = part.data
        let {duration,runCount} = animation&&animation.animation || {}
        setForm({duration,animationType,runCount,animationProp,animationTarget})
        lastNode = part
      }
    })
    const ids = ['duration','animationType','runCount','animationProp','animationTarget']
    function setForm(data){
      ids.forEach(id=>{
        const ele = document.getElementById(id);
        ele.value = data[id]
        if(id === 'animationProp'){
          ele.value = 'state'
        }
      })
    }
    function getDataFromForm(){
      return ids.map(id=>{ 
        const ele = document.getElementById(id);
        return ele.value
      })
    }
    myDiagram.model.addChangedListener(evt=>{
      const part = evt.object
      if(part && part.animationProp){
        if(evt.propertyName === part.animationProp){
          if(part[part.animationProp] == part.animationTarget){
            const animation = part.animation
            animation&&animation.start()
          } else {
            const animation = part.animation
            animation&&animation.clearMarks()
          }
        }
      }
    })
    function clearMark(){
      myDiagram.nodes.each(node=>{
        node.animation && node.animation.clearMark()
      })
    }
    </script>
  </body>
</html>
